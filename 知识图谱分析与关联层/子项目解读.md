# 知识图谱分析与关联层｜Neo4j 知识图谱 + Apriori 关联规则子项目解读

> 说明：本文中出现的相对路径，默认以项目根目录 `E:\PycharmProjects\三创赛` 为基准。

## 1. 子项目定位（在全链路中的作用）

本层将结构化数据与 NLP 洞察进一步升级为：

1. **知识图谱（Neo4j）**：把产品、品牌、材质、刀型、痛点（painpoint）等实体及其关系显式化，便于查询与故事化展示。
2. **关联规则（Apriori）**：在商品“属性组合”层面发现高共现模式（例如“某材质 + 某价位 → 更易出现某痛点”），形成可解释的运营/选品建议。

并输出 6 张“比赛展示图”（PNG+SVG），作为项目书的“洞察故事线”主素材。

---

## 2. 本层使用的数据（输入文件）

默认输入（见 `README.md`）：

- `第三层预测建模/data/products_clean.csv`
- `第三层预测建模/data/reviews_cleaned.csv`
- `第三层预测建模/data/absa_detailed.csv`
- （可选）`amazon_spasers_v2.0/data/amazon_data.db` 的 `search_results` 表（补充搜索端信息）

词典/映射（可编辑，支持迭代）：

- `dict/painpoint_map.csv`：ABSA aspect → painpoint_norm
- `dict/material_lexicon.csv`：材质抽取规则（pattern → norm）
- `dict/knife_type_lexicon.csv`：刀型抽取规则（pattern → norm）

---

## 3. 核心脚本与做了什么

### 3.1 `prepare_kg_assoc.py`（一键生成图谱导出 + 关联分析输入）

**解决问题**：把“表格数据”组织成两套标准产物：

- Neo4j 可导入的节点表/边表（CSV）
- Apriori 可用的“交易表”（transaction items）

**关键技术点**：

- 词典/正则抽取实体（材质、刀型）
- 将 ABSA 方面情感映射到痛点（painpoint），并在商品粒度聚合：
  - 输出 `reports/product_painpoint_agg.csv`（asin×painpoint 的提及数、负面率等）
- 将价格/评分/销量代理等做分桶（price_tier / rating_bucket / sales_bucket），用于关联规则的可解释项
- （可选）读取爬虫 SQLite 的 `search_results` 补充“品牌竞争/搜索位次”等边

**输出目录**（均在本层目录下）：

- `kg_export/`：Neo4j 导入 CSV（节点表 + 边表）
- `assoc_export/`：Apriori 输入 CSV（交易表）
- `reports/`：数据质量摘要与 painpoint 聚合

### 3.2 `run_apriori_rules.py`（Apriori 规则挖掘）

特点：不依赖 `mlxtend`，纯 Python 实现（更利于比赛环境复现）。

默认策略：

- `max_len=3`（最大 3 项集）
- consequent 限制为 1 项（更适合展示）
- 输出 Top 50 规则，指标包含：support / confidence / lift

输出：

- `assoc_export/apriori_rules.csv`
- `reports/apriori_rules.md`

### 3.3 `generate_viz.py`（比赛展示图：6 张）

输出目录：`visuals/`（同名 PNG+SVG）

1. `painpoint_sentiment_overview`：各痛点正负面堆叠概览
2. `painpoint_negative_rate_by_price_tier`：痛点负面率随价位分层变化
3. `painpoint_negative_rate_by_knife_type`：不同刀型的痛点负面率
4. `painpoint_negative_rate_by_material`：不同材质的痛点负面率
5. `brand_painpoint_profile_top5`：Top5 品牌痛点雷达画像
6. `apriori_painpoint_rules_top`：Top 规则可视化（聚焦 consequent 为 painpoint）

---

## 4. 输出数据与文件代表什么（项目书写法重点）

### 4.1 知识图谱导入文件（`kg_export/`）

节点表（示例）：

- `node_product.csv`：产品节点（price/rating/bsr/is_fba/has_aplus…）
- `node_brand.csv`：品牌节点
- `node_material.csv`：材质节点
- `node_knife_type.csv`：刀型节点
- `node_painpoint.csv`：痛点节点（锋利/防锈/耐用/手柄舒适…）
- `node_keyword.csv`：关键词节点（若启用）

边表（示例）：

- `edge_brand_sells_product.csv`：品牌→商品
- `edge_product_has_material.csv`：商品→材质
- `edge_product_has_knife_type.csv`：商品→刀型
- `edge_product_has_painpoint.csv`：商品→痛点（带提及与负面率等权重）
- `edge_keyword_ranks_product.csv`：关键词→商品（可选）
- `edge_brand_competes_brand.csv`：品牌竞争关系（可选）

项目书写法：把 Neo4j 图谱描述成“**从数据到关系网络的抽象**”，强调可查询、可扩展、可视化呈现。

### 4.2 关联分析输入与规则（`assoc_export/`）

- `transactions_product.csv`
  - 每个 `transaction_id` 对应一个 `asin`
  - `items` 为用 `|` 拼接的属性项（例如 `material=stainless|knife_type=chef|price_tier=1|painpoint=rust_resistance`）

- `apriori_rules.csv`
  - `support`：规则在全体商品中的覆盖率
  - `confidence`：在 antecedent 成立条件下 consequent 成立概率
  - `lift`：相对提升（>1 表示正关联）

项目书写法：强调“可解释的组合规律”，适合指导选品组合与风险预警。

### 4.3 痛点聚合（`reports/`）

- `product_painpoint_agg.csv`：商品×痛点聚合（`mention_n/neg_ratio/avg_score`）
- `data_quality_summary.json`：覆盖率/抽取质量摘要（可作为附录）

---

## 5. 6 张展示图怎么解读（项目书可直接用的逐图话术）

> 这些图在 `visuals/` 下已生成：`*.png` 与 `*.svg`（SVG 适合项目书排版）

1. `painpoint_sentiment_overview.png`
   - 讲法：*“图X 展示各痛点的正负面反馈规模，帮助确定优化优先级：负面量高的痛点应优先投入研发与质控。”*

2. `painpoint_negative_rate_by_price_tier.png`
   - 讲法：*“图X 说明痛点负面率随价位分层存在差异，可用于制定不同价位段的产品策略与质控标准。”*

3. `painpoint_negative_rate_by_knife_type.png`
   - 讲法：*“图X 对比不同刀型的痛点负面率，识别‘风险刀型’与‘优势刀型’，用于选品组合与差异化定位。”*

4. `painpoint_negative_rate_by_material.png`
   - 讲法：*“图X 从材质维度解释痛点来源，例如某些材质更易引发生锈/崩口等负面评价，为材料选择与工艺改进提供依据。”*

5. `brand_painpoint_profile_top5.png`
   - 讲法：*“图X 给出 Top5 品牌的痛点画像雷达图：不同品牌在痛点维度上呈现差异化优势与短板，可用于制定竞品对标策略。”*

6. `apriori_painpoint_rules_top.png`
   - 讲法：*“图X 展示与痛点相关的高 lift 规则，识别‘属性组合 → 痛点’的风险模式，为新品设计与质控预警提供可解释证据链。”*

---

## 6. 复现运行方式（命令级）

建议在项目根目录 `E:\\PycharmProjects\\三创赛` 下执行（也可在本目录直接运行脚本，按需调整相对路径）：

```powershell
# 1) 生成 Neo4j 导入 CSV + Apriori 交易表 + 数据质量报告
powershell -NoProfile -Command "python .\\知识图谱分析与关联层\\prepare_kg_assoc.py"

# 2) 生成 Apriori 规则
powershell -NoProfile -Command "python .\\知识图谱分析与关联层\\run_apriori_rules.py"

# 3) 生成 6 张比赛展示图（PNG + SVG）
powershell -NoProfile -Command "python .\\知识图谱分析与关联层\\generate_viz.py"
```

---

## 7. Neo4j 导入说明（项目书可放附录）

参考：`neo4j_load_example.cypher`

要点：

1. 将 `kg_export/*.csv` 放入 Neo4j 的 `import` 目录
2. 使用 `LOAD CSV WITH HEADERS` 导入节点与边
3. 建立索引/约束（例如 `:Product(product_id)` 唯一）

---

## 8. 注意事项与可迭代方向

- 词典（材质/刀型/痛点映射）可持续迭代：更新 `dict/*.csv` 后重跑即可刷新图谱与规则。
- 关联规则可按业务需求调参（min_support/min_confidence），建议在项目书说明“规则挖掘阈值”以增强可复现性。
